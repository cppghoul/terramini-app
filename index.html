<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terra OTC - –ú–∏–Ω–∏ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 16px;
            color: #333;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .header h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 8px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .navigation {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .nav-btn {
            padding: 12px;
            border: none;
            border-radius: 12px;
            background: #f8f9fa;
            color: #333;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-btn.active {
            background: #667eea;
            color: white;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
        }

        /* –°–µ–∫—Ü–∏–∏ */
        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* –°—Ç–∞—Ç—É—Å –∫–æ—à–µ–ª—å–∫–∞ */
        .wallet-status {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }

        .wallet-connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .wallet-disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-loading {
            color: #666;
            text-align: center;
            padding: 20px;
        }

        /* –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è */
        .quick-actions {
            margin-bottom: 20px;
        }

        .quick-actions h3 {
            margin-bottom: 12px;
            font-size: 16px;
            color: #333;
        }

        .action-btn {
            width: 100%;
            padding: 15px;
            margin-bottom: 10px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            background: white;
            color: #333;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .action-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 11px;
            color: #666;
        }

        /* –§–æ—Ä–º—ã */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn-primary {
            width: 100%;
            background: #667eea;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            margin-bottom: 15px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            background: #5a6fd8;
        }

        .btn-primary:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            width: 100%;
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 8px;
            transition: transform 0.2s ease;
        }

        .btn-secondary:hover {
            transform: translateY(-1px);
            background: #5a6268;
        }

        /* –°–¥–µ–ª–∫–∏ */
        .deal-item, .referral-item, .nft-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .deal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .deal-amount {
            font-weight: bold;
            font-size: 16px;
            color: #333;
        }

        .deal-status {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-created { background: #fff3cd; color: #856404; }
        .status-buyer_joined { background: #d1ecf1; color: #0c5460; }
        .status-paid { background: #d4edda; color: #155724; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-cancelled { background: #f8d7da; color: #721c24; }

        .deal-description {
            color: #666;
            margin-bottom: 10px;
            line-height: 1.4;
            font-size: 14px;
        }

        .deal-link {
            background: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #e9ecef;
        }

        .deal-link code {
            font-family: monospace;
            background: #f8f9fa;
            padding: 2px 4px;
            border-radius: 4px;
            font-size: 11px;
            word-break: break-all;
        }

        .deal-actions {
            display: flex;
            gap: 8px;
        }

        /* –†–µ—Ñ–µ—Ä–∞–ª—ã */
        .referral-stats {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .referral-link-card {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 2px solid #b3d9ff;
        }

        .referral-link {
            background: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #e9ecef;
        }

        .referral-link code {
            font-family: monospace;
            background: #f8f9fa;
            padding: 2px 4px;
            border-radius: 4px;
            font-size: 12px;
            word-break: break-all;
        }

        .referral-item {
            border-left-color: #28a745;
        }

        /* NFT –æ–±–º–µ–Ω—ã */
        .nft-item {
            border-left-color: #ffc107;
        }

        .nft-status {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 5px;
            display: inline-block;
        }

        .nft-status.waiting { background: #fff3cd; color: #856404; }
        .nft-status.processing { background: #d1ecf1; color: #0c5460; }
        .nft-status.completed { background: #d4edda; color: #155724; }
        .nft-status.cancelled { background: #f8d7da; color: #721c24; }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            max-width: 90%;
            text-align: center;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        .notification.success {
            background: #28a745;
        }

        .notification.error {
            background: #dc3545;
        }

        .notification.warning {
            background: #ffc107;
            color: #333;
        }

        .hidden {
            display: none;
        }

        /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Å–µ–∫—Ü–∏–π */
        .section h2 {
            font-size: 20px;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
        }

        .section h3 {
            font-size: 16px;
            font-weight: 700;
            color: #333;
            margin-bottom: 12px;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 480px) {
            .container {
                padding: 15px;
                margin: 10px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .navigation {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .deal-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="header">
            <h1>üíº Terra OTC</h1>
            <p>–ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ P2P-—Å–¥–µ–ª–∫–∏ —á–µ—Ä–µ–∑ –≥–∞—Ä–∞–Ω—Ç–∞</p>
        </div>

        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
        <div class="navigation">
            <button class="nav-btn active" onclick="showSection('main')">üè† –ì–ª–∞–≤–Ω–∞—è</button>
            <button class="nav-btn" onclick="showSection('deals')">üìÑ –°–¥–µ–ª–∫–∏</button>
            <button class="nav-btn" onclick="showSection('referrals')">üë• –†–µ—Ñ–µ—Ä–∞–ª—ã</button>
            <button class="nav-btn" onclick="showSection('nft')">üîÑ –û–±–º–µ–Ω—ã NFT</button>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div id="mainSection" class="section active">
            <!-- –°—Ç–∞—Ç—É—Å –∫–æ—à–µ–ª—å–∫–∞ -->
            <div class="wallet-status" id="walletStatus">
                <div class="status-loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ—à–µ–ª—å–∫–∞...</div>
            </div>

            <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
            <div class="quick-actions">
                <h3>‚ö° –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
                <button class="action-btn" onclick="showSection('deals')">
                    üìÑ –°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É
                </button>
                <button class="action-btn" onclick="showSection('referrals')">
                    üë• –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞
                </button>
                <button class="action-btn" onclick="showSection('nft')">
                    üîÑ –û–±–º–µ–Ω NFT
                </button>
            </div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="activeDealsCount">0</div>
                    <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalReferralsCount">0</div>
                    <div class="stat-label">–†–µ—Ñ–µ—Ä–∞–ª–æ–≤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="nftExchangesCount">0</div>
                    <div class="stat-label">–û–±–º–µ–Ω–æ–≤ NFT</div>
                </div>
            </div>
        </div>

        <!-- –°–µ–∫—Ü–∏—è —Å–¥–µ–ª–æ–∫ -->
        <div id="dealsSection" class="section">
            <h2>üìÑ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–¥–µ–ª–∫–∞–º–∏</h2>
            
            <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏ -->
            <div class="deal-form">
                <h3>üÜï –°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É</h3>
                
                <div class="form-group">
                    <label>üíé –í–∞–ª—é—Ç–∞:</label>
                    <select id="currencySelect" class="form-select">
                        <option value="TON">üíé TON</option>
                        <option value="RUB">üíµ RUB</option>
                        <option value="UAH">üá∫üá¶ UAH</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>üí∞ –°—É–º–º–∞:</label>
                    <input type="number" id="amountInput" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É" step="0.01" min="0.01">
                </div>

                <div class="form-group">
                    <label>üìù –û–ø–∏—Å–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏:</label>
                    <textarea id="descriptionInput" class="form-textarea" placeholder="–û–ø–∏—à–∏—Ç–µ —á—Ç–æ –ø—Ä–æ–¥–∞–µ—Ç–µ/–ø–æ–∫—É–ø–∞–µ—Ç–µ..."></textarea>
                </div>

                <button class="btn-primary" onclick="createDeal()">üöÄ –°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É</button>
            </div>

            <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–¥–µ–ª–∫–∏ -->
            <div class="deals-list">
                <h3>üìä –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–¥–µ–ª–∫–∏</h3>
                <div id="dealsContainer">
                    <div class="status-loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–¥–µ–ª–æ–∫...</div>
                </div>
            </div>
        </div>

        <!-- –°–µ–∫—Ü–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ -->
        <div id="referralsSection" class="section">
            <h2>üë• –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</h2>
            
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ -->
            <div class="referral-stats" id="referralStats">
                <div class="status-loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</div>
            </div>

            <!-- –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ -->
            <div class="referral-link-card">
                <h3>üîó –í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞</h3>
                <div class="referral-link" id="referralLinkContainer">
                    <code id="referralLink">–ó–∞–≥—Ä—É–∑–∫–∞...</code>
                </div>
                <button class="btn-secondary" onclick="copyReferralLink()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
                <button class="btn-secondary" onclick="shareReferralLink()">üîó –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ -->
            <div class="referrals-list">
                <h3>üë§ –í–∞—à–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—ã</h3>
                <div id="referralsListContainer">
                    <div class="status-loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤...</div>
                </div>
            </div>
        </div>

        <!-- –°–µ–∫—Ü–∏—è NFT –æ–±–º–µ–Ω–æ–≤ -->
        <div id="nftSection" class="section">
            <h2>üîÑ –û–±–º–µ–Ω—ã NFT</h2>
            
            <!-- –°–æ–∑–¥–∞–Ω–∏–µ –æ–±–º–µ–Ω–∞ -->
            <div class="nft-form">
                <h3>üÜï –°–æ–∑–¥–∞—Ç—å –æ–±–º–µ–Ω NFT</h3>
                
                <div class="form-group">
                    <label>üì¶ –û–ø–∏—Å–∞–Ω–∏–µ –≤–∞—à–µ–≥–æ NFT:</label>
                    <textarea id="nftDescription" class="form-textarea" placeholder="–û–ø–∏—à–∏—Ç–µ —á—Ç–æ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç–µ –¥–ª—è –æ–±–º–µ–Ω–∞..."></textarea>
                </div>

                <div class="form-group">
                    <label>üë§ ID –ø–∞—Ä—Ç–Ω–µ—Ä–∞:</label>
                    <input type="number" id="partnerId" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –ø–∞—Ä—Ç–Ω–µ—Ä–∞">
                </div>

                <button class="btn-primary" onclick="createNftExchange()">üîÑ –°–æ–∑–¥–∞—Ç—å –æ–±–º–µ–Ω</button>
            </div>

            <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ –æ–±–º–µ–Ω—ã -->
            <div class="nft-exchanges">
                <h3>üìã –ê–∫—Ç–∏–≤–Ω—ã–µ –æ–±–º–µ–Ω—ã</h3>
                <div id="nftExchangesContainer">
                    <div class="status-loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–º–µ–Ω–æ–≤...</div>
                </div>
            </div>
        </div>

        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        <div id="notification" class="notification hidden"></div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        const tg = window.Telegram.WebApp;
        let userData = null;
        let currentSection = 'main';

        // –ë–∞–∑–æ–≤—ã–π URL API
        const API_BASE_URL = 'https://terra-production-225a.up.railway.app/api';

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        tg.expand();
        tg.enableClosingConfirmation();

        // –û—Å–Ω–æ–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
        const mainButton = tg.MainButton;
        const backButton = tg.BackButton;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        async function initApp() {
            try {
                console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                userData = tg.initDataUnsafe?.user;
                
                if (!userData) {
                    console.error('‚ùå userData –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω:', tg.initDataUnsafe);
                    showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–∞–∂–µ –±–µ–∑ userData
                    showSection('main');
                    setupTelegramButtons();
                    return;
                }

                console.log('üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω:', userData);
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                await loadWalletStatus();
                await loadMainStats();
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ Telegram
                setupTelegramButtons();
                
                console.log('‚úÖ –ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è', 'error');
                
                // –í—Å–µ —Ä–∞–≤–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                showSection('main');
                setupTelegramButtons();
            }
        }

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å–µ–∫—Ü–∏—è–º
        function showSection(sectionName) {
            console.log('üì± –ü–µ—Ä–µ—Ö–æ–¥ –≤ —Å–µ–∫—Ü–∏—é:', sectionName, 'userData:', userData);
            
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–µ–∫—Ü–∏–∏
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å–µ–∫—Ü–∏—é
            const targetSection = document.getElementById(sectionName + 'Section');
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∫–Ω–æ–ø–∫—É
            const targetButton = document.querySelector(`.nav-btn[onclick="showSection('${sectionName}')"]`);
            if (targetButton) {
                targetButton.classList.add('active');
            }
            
            currentSection = sectionName;
            updateMainButton();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å–µ–∫—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ userData –¥–æ—Å—Ç—É–ø–µ–Ω)
            if (userData && userData.id) {
                switch(sectionName) {
                    case 'deals':
                        loadUserDeals();
                        break;
                    case 'referrals':
                        loadReferralInfo();
                        break;
                    case 'nft':
                        loadNftExchanges();
                        break;
                    case 'main':
                        loadMainStats();
                        break;
                }
            } else {
                console.warn('‚ö†Ô∏è userData –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ—à–µ–ª—å–∫–∞
        async function loadWalletStatus() {
            try {
                const walletStatus = document.getElementById('walletStatus');
                if (!walletStatus) return;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å userData
                if (!userData || !userData.id) {
                    walletStatus.innerHTML = `
                        <div class="wallet-disconnected">
                            ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
                            <div style="font-size: 12px; margin-top: 5px;">
                                –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                            </div>
                        </div>
                    `;
                    return;
                }
                
                walletStatus.innerHTML = '<div class="status-loading">‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—à–µ–ª—å–∫–∞...</div>';
                
                const walletData = await apiCall('/wallet/check', { user_id: userData.id });
                
                if (walletData && walletData.has_wallet) {
                    const walletInfo = walletData.wallet_info;
                    let walletDisplay = '';
                    
                    if (walletInfo && walletInfo.wallet_type === 'card') {
                        const maskedCard = walletInfo.wallet ? `****${walletInfo.wallet.slice(-4)}` : '–Ω–µ —É–∫–∞–∑–∞–Ω';
                        walletDisplay = `üí≥ –ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞: ${maskedCard}`;
                    } else if (walletInfo && walletInfo.wallet_type === 'crypto') {
                        const shortWallet = walletInfo.wallet ? `${walletInfo.wallet.slice(0, 8)}...${walletInfo.wallet.slice(-6)}` : '–Ω–µ —É–∫–∞–∑–∞–Ω';
                        walletDisplay = `üí∞ TON-–∫–æ—à–µ–ª–µ–∫: ${shortWallet}`;
                    } else {
                        walletDisplay = '‚úÖ –ö–æ—à–µ–ª–µ–∫ –ø—Ä–∏–≤—è–∑–∞–Ω';
                    }
                    
                    walletStatus.innerHTML = `
                        <div class="wallet-connected">
                            ‚úÖ –ö–æ—à–µ–ª–µ–∫ –ø—Ä–∏–≤—è–∑–∞–Ω
                            <div style="font-size: 12px; margin-top: 5px;">
                                ${walletDisplay}
                            </div>
                        </div>
                    `;
                } else {
                    walletStatus.innerHTML = `
                        <div class="wallet-disconnected">
                            ‚ùå –ö–æ—à–µ–ª–µ–∫ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω
                            <div style="font-size: 12px; margin-top: 5px;">
                                –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–æ–∫ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏–≤—è–∑–∞—Ç—å –∫–æ—à–µ–ª–µ–∫ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –±–æ—Ç–µ
                            </div>
                            <button class="btn-secondary" onclick="openBot()" style="margin-top: 10px;">
                                üì≤ –û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞
                            </button>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ—à–µ–ª—å–∫–∞:', error);
                const walletStatus = document.getElementById('walletStatus');
                if (walletStatus) {
                    walletStatus.innerHTML = `
                        <div class="wallet-disconnected">
                            ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ—à–µ–ª—å–∫–∞
                            <div style="font-size: 12px; margin-top: 5px;">
                                ${error.message}
                            </div>
                        </div>
                    `;
                }
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        async function loadMainStats() {
            try {
                if (!userData || !userData.id) {
                    console.warn('userData –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
                    return;
                }

                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–¥–µ–ª–∫–∏ –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞
                const deals = await apiCall('/deals/user', { user_id: userData.id });
                const activeDeals = deals ? deals.filter(deal => 
                    deal && ['created', 'buyer_joined', 'paid'].includes(deal.status)
                ) : [];

                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                const referralStats = await apiCall('/referrals/stats', { user_id: userData.id });
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º NFT –æ–±–º–µ–Ω—ã
                const nftExchanges = await apiCall('/nft/exchanges', { user_id: userData.id });
                const activeExchanges = nftExchanges ? nftExchanges.filter(exchange => 
                    exchange && ['waiting_partner', 'waiting_nft_descriptions', 'waiting_deposits', 'processing'].includes(exchange.status)
                ) : [];
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                updateCounter('activeDealsCount', activeDeals.length);
                updateCounter('totalReferralsCount', referralStats ? (referralStats.total_referrals || 0) : 0);
                updateCounter('nftExchangesCount', activeExchanges.length);
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
                updateCounter('activeDealsCount', 0);
                updateCounter('totalReferralsCount', 0);
                updateCounter('nftExchangesCount', 0);
            }
        }

        // –ê–Ω–∏–º–∞—Ü–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤
        function updateCounter(elementId, value) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            element.textContent = value;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–¥–µ–ª–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadUserDeals() {
            try {
                const dealsContainer = document.getElementById('dealsContainer');
                if (!dealsContainer) return;
                
                if (!userData || !userData.id) {
                    dealsContainer.innerHTML = `
                        <div style="text-align: center; color: #666; padding: 20px;">
                            ‚ùå –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
                        </div>
                    `;
                    return;
                }

                dealsContainer.innerHTML = '<div class="status-loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–¥–µ–ª–æ–∫...</div>';

                const deals = await apiCall('/deals/user', { user_id: userData.id });
                
                if (!deals || deals.length === 0) {
                    dealsContainer.innerHTML = `
                        <div style="text-align: center; color: #666; padding: 20px;">
                            üìù –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Å–¥–µ–ª–æ–∫
                        </div>
                    `;
                    return;
                }

                dealsContainer.innerHTML = deals.map(deal => `
                    <div class="deal-item">
                        <div class="deal-header">
                            <span class="deal-amount">${deal.amount} ${deal.currency}</span>
                            <span class="deal-status status-${deal.status}">
                                ${getDealStatusText(deal.status)}
                            </span>
                        </div>
                        <div class="deal-description">${deal.description}</div>
                        <div class="deal-link">
                            <strong>–°—Å—ã–ª–∫–∞ –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è:</strong><br>
                            <code>${deal.link}</code>
                        </div>
                        <div class="deal-actions">
                            <button class="btn-secondary" onclick="copyToClipboard('${deal.link}')">
                                üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                            <button class="btn-secondary" onclick="shareLink('${deal.link}', '–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ –º–æ–µ–π —Å–¥–µ–ª–∫–µ –≤ Terra OTC!')">
                                üîó –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
                            </button>
                            ${deal.status === 'created' ? `
                            <button class="btn-secondary" onclick="cancelDeal('${deal.id}')" style="background: #dc3545;">
                                ‚ùå –û—Ç–º–µ–Ω–∏—Ç—å
                            </button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–¥–µ–ª–æ–∫:', error);
                const dealsContainer = document.getElementById('dealsContainer');
                if (dealsContainer) {
                    dealsContainer.innerHTML = `
                        <div style="text-align: center; color: #dc3545; padding: 20px;">
                            ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–¥–µ–ª–æ–∫: ${error.message}
                        </div>
                    `;
                }
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å–¥–µ–ª–∫–∏
        async function createDeal() {
            try {
                if (!userData || !userData.id) {
                    showNotification('‚ùå –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'error');
                    return;
                }

                const currency = document.getElementById('currencySelect')?.value || 'TON';
                const amountInput = document.getElementById('amountInput');
                const descriptionInput = document.getElementById('descriptionInput');
                
                if (!amountInput || !descriptionInput) {
                    showNotification('–û—à–∏–±–∫–∞: —Ñ–æ—Ä–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
                    return;
                }

                const amount = parseFloat(amountInput.value);
                const description = descriptionInput.value.trim();

                // –í–∞–ª–∏–¥–∞—Ü–∏—è
                if (!amount || amount <= 0) {
                    showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É', 'error');
                    return;
                }

                if (!description) {
                    showNotification('–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏', 'error');
                    return;
                }

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
                const button = document.querySelector('#dealsSection .btn-primary');
                if (button) {
                    const originalText = button.textContent;
                    button.textContent = '‚è≥ –°–æ–∑–¥–∞–Ω–∏–µ...';
                    button.disabled = true;

                    // –°–æ–∑–¥–∞–µ–º —Å–¥–µ–ª–∫—É
                    const result = await apiCall('/deals/create', {
                        user_id: userData.id,
                        currency: currency,
                        amount: amount,
                        description: description
                    }, 'POST');

                    if (result && result.success) {
                        showNotification('‚úÖ –°–¥–µ–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!', 'success');
                        
                        // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                        amountInput.value = '';
                        descriptionInput.value = '';
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                        await loadUserDeals();
                        await loadMainStats();
                    } else {
                        showNotification('‚ùå ' + (result?.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–¥–µ–ª–∫–∏'), 'error');
                    }

                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                    button.textContent = originalText;
                    button.disabled = false;
                }

            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏:', error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–¥–µ–ª–∫–∏: ' + error.message, 'error');
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
                const button = document.querySelector('#dealsSection .btn-primary');
                if (button) {
                    button.textContent = 'üöÄ –°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É';
                    button.disabled = false;
                }
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        async function loadReferralInfo() {
            try {
                if (!userData || !userData.id) {
                    console.warn('userData –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤');
                    return;
                }

                const stats = await apiCall('/referrals/stats', { user_id: userData.id });
                const referrals = await apiCall('/referrals/list', { user_id: userData.id });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                const statsContainer = document.getElementById('referralStats');
                if (statsContainer) {
                    statsContainer.innerHTML = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #667eea;">${stats ? (stats.total_referrals || 0) : 0}</div>
                                <div style="font-size: 12px; color: #666;">–í—Å–µ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #28a745;">${stats ? (stats.active_referrals || 0) : 0}</div>
                                <div style="font-size: 12px; color: #666;">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
                            </div>
                        </div>
                    `;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É
                const linkElement = document.getElementById('referralLink');
                if (linkElement) {
                    linkElement.textContent = stats ? (stats.referral_link || '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ') : '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
                const container = document.getElementById('referralsListContainer');
                if (container) {
                    if (!referrals || referrals.length === 0) {
                        container.innerHTML = `
                            <div style="text-align: center; color: #666; padding: 20px;">
                                üë• –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
                            </div>
                        `;
                    } else {
                        container.innerHTML = referrals.map(ref => `
                            <div class="referral-item">
                                <div style="font-weight: bold; margin-bottom: 5px;">üë§ ID: ${ref.user_id}</div>
                                <div style="font-size: 12px; color: #666;">
                                    –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è: ${ref.joined || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}<br>
                                    –°—Ç–∞—Ç—É—Å: ${ref.transferred_gifts && ref.transferred_gifts.length > 0 ? '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω' : '‚è≥ –û–∂–∏–¥–∞–µ—Ç'}
                                </div>
                            </div>
                        `).join('');
                    }
                }
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ NFT –æ–±–º–µ–Ω–æ–≤
        async function loadNftExchanges() {
            try {
                if (!userData || !userData.id) {
                    console.warn('userData –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ NFT –æ–±–º–µ–Ω–æ–≤');
                    return;
                }

                const exchanges = await apiCall('/nft/exchanges', { user_id: userData.id });
                const container = document.getElementById('nftExchangesContainer');
                
                if (!container) return;
                
                if (!exchanges || exchanges.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; color: #666; padding: 20px;">
                            üîÑ –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –æ–±–º–µ–Ω–æ–≤ NFT
                        </div>
                    `;
                    return;
                }

                container.innerHTML = exchanges.map(exchange => `
                    <div class="nft-item">
                        <div class="nft-status ${exchange.status}">
                            ${getNftStatusText(exchange.status)}
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>ID –æ–±–º–µ–Ω–∞:</strong> ${exchange.exchange_id}<br>
                            <strong>–ü–∞—Ä—Ç–Ω–µ—Ä:</strong> #${exchange.partner_id}<br>
                            <strong>–í–∞—à–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:</strong> ${exchange.initiator_nft}<br>
                            ${exchange.partner_nft ? `<strong>–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–∞—Ä—Ç–Ω–µ—Ä–∞:</strong> ${exchange.partner_nft}<br>` : ''}
                        </div>
                        <div style="font-size: 12px; color: #666;">
                            –°–æ–∑–¥–∞–Ω: ${exchange.created_at}
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ NFT –æ–±–º–µ–Ω–æ–≤:', error);
                const container = document.getElementById('nftExchangesContainer');
                if (container) {
                    container.innerHTML = `
                        <div style="text-align: center; color: #dc3545; padding: 20px;">
                            ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–º–µ–Ω–æ–≤
                        </div>
                    `;
                }
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ NFT –æ–±–º–µ–Ω–∞
        async function createNftExchange() {
            try {
                if (!userData || !userData.id) {
                    showNotification('‚ùå –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'error');
                    return;
                }

                const descriptionInput = document.getElementById('nftDescription');
                const partnerInput = document.getElementById('partnerId');
                
                if (!descriptionInput || !partnerInput) {
                    showNotification('–û—à–∏–±–∫–∞: —Ñ–æ—Ä–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
                    return;
                }

                const description = descriptionInput.value.trim();
                const partnerId = partnerInput.value.trim();

                if (!description) {
                    showNotification('–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ NFT', 'error');
                    return;
                }

                if (!partnerId) {
                    showNotification('–í–≤–µ–¥–∏—Ç–µ ID –ø–∞—Ä—Ç–Ω–µ—Ä–∞', 'error');
                    return;
                }

                const result = await apiCall('/nft/exchanges/create', {
                    user_id: userData.id,
                    nft_description: description,
                    partner_id: parseInt(partnerId)
                }, 'POST');

                if (result && result.success) {
                    showNotification('‚úÖ –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –Ω–∞ –æ–±–º–µ–Ω –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!', 'success');
                    descriptionInput.value = '';
                    partnerInput.value = '';
                    await loadNftExchanges();
                    await loadMainStats();
                } else {
                    showNotification('‚ùå ' + (result?.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ–±–º–µ–Ω–∞'), 'error');
                }

            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è NFT –æ–±–º–µ–Ω–∞:', error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ–±–º–µ–Ω–∞: ' + error.message, 'error');
            }
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function getDealStatusText(status) {
            const statusMap = {
                'created': '–û–∂–∏–¥–∞–µ—Ç –ø–æ–∫—É–ø–∞—Ç–µ–ª—è',
                'buyer_joined': '–ü–æ–∫—É–ø–∞—Ç–µ–ª—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è', 
                'paid': '–û–ø–ª–∞—á–µ–Ω–æ',
                'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω–∞',
                'cancelled': '–û—Ç–º–µ–Ω–µ–Ω–∞'
            };
            return statusMap[status] || status;
        }

        function getNftStatusText(status) {
            const statusMap = {
                'waiting_partner': '‚è≥ –û–∂–∏–¥–∞–µ—Ç –ø–∞—Ä—Ç–Ω–µ—Ä–∞',
                'waiting_nft_descriptions': 'üìù –û–∂–∏–¥–∞–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è NFT',
                'waiting_deposits': 'üí∞ –û–∂–∏–¥–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ NFT',
                'processing': '‚ö° –í –ø—Ä–æ—Ü–µ—Å—Å–µ –æ–±–º–µ–Ω–∞',
                'completed': '‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω',
                'cancelled': '‚ùå –û—Ç–º–µ–Ω–µ–Ω'
            };
            return statusMap[status] || status;
        }

        // –û—Ç–º–µ–Ω–∞ —Å–¥–µ–ª–∫–∏
        async function cancelDeal(dealId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —Å–¥–µ–ª–∫—É?')) return;
            
            try {
                if (!userData || !userData.id) {
                    showNotification('‚ùå –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'error');
                    return;
                }

                const result = await apiCall('/deals/cancel', {
                    user_id: userData.id,
                    deal_id: dealId
                }, 'POST');
                
                if (result && result.success) {
                    showNotification('‚úÖ –°–¥–µ–ª–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞', 'success');
                    await loadUserDeals();
                    await loadMainStats();
                } else {
                    showNotification('‚ùå ' + (result?.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ —Å–¥–µ–ª–∫–∏'), 'error');
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã —Å–¥–µ–ª–∫–∏:', error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ —Å–¥–µ–ª–∫–∏: ' + error.message, 'error');
            }
        }

        // –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function copyReferralLink() {
            const linkElement = document.getElementById('referralLink');
            if (linkElement) {
                copyToClipboard(linkElement.textContent);
            }
        }

        function shareReferralLink() {
            const linkElement = document.getElementById('referralLink');
            if (linkElement) {
                shareLink(linkElement.textContent, '–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ Terra OTC –ø–æ –º–æ–µ–π —Å—Å—ã–ª–∫–µ!');
            }
        }

        // –£—Ç–∏–ª–∏—Ç—ã
        function copyToClipboard(text) {
            if (!text || text === '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ') {
                showNotification('‚ùå –ù–µ—á–µ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å', 'error');
                return;
            }
            
            navigator.clipboard.writeText(text).then(() => {
                showNotification('‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success');
            }).catch(() => {
                // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showNotification('‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success');
            });
        }

        function shareLink(link, text) {
            if (!link || link === '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ') {
                showNotification('‚ùå –ù–µ—á–µ–≥–æ –¥–µ–ª–∏—Ç—å—Å—è', 'error');
                return;
            }
            
            if (tg.isVersionAtLeast('6.1')) {
                tg.shareUrl(link, text);
            } else {
                copyToClipboard(link);
                showNotification('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞. –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –µ–π –≤—Ä—É—á–Ω—É—é.', 'warning');
            }
        }

        function openBot() {
            tg.openTelegramLink('https://t.me/Terra_Otc_bot');
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            if (!notification) return;
            
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è API –≤—ã–∑–æ–≤–æ–≤ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
        async function apiCall(endpoint, params = {}, method = 'GET') {
            try {
                let url = `${API_BASE_URL}${endpoint}`;
                let options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    mode: 'cors',
                    credentials: 'omit'
                };

                if (method === 'GET') {
                    const queryParams = new URLSearchParams(params).toString();
                    if (queryParams) {
                        url += `?${queryParams}`;
                    }
                } else {
                    options.body = JSON.stringify(params);
                }

                console.log(`üîç API Call: ${url}`, params);
                
                const response = await fetch(url, options);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log(`‚úÖ API Response:`, data);
                return data;
                
            } catch (error) {
                console.error(`‚ùå API Error (${endpoint}):`, error);
                throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É: ${error.message}`);
            }
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–æ–∫ Telegram
        function setupTelegramButtons() {
            updateMainButton();
            
            // –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥
            backButton.show();
            backButton.onClick(() => {
                if (currentSection !== 'main') {
                    showSection('main');
                } else {
                    tg.close();
                }
            });
        }

        function updateMainButton() {
            switch(currentSection) {
                case 'deals':
                    mainButton.setText("üìÑ –°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É");
                    mainButton.onClick(createDeal);
                    break;
                case 'nft':
                    mainButton.setText("üîÑ –°–æ–∑–¥–∞—Ç—å –æ–±–º–µ–Ω");
                    mainButton.onClick(createNftExchange);
                    break;
                default:
                    mainButton.setText("üè† –ì–ª–∞–≤–Ω–∞—è");
                    mainButton.onClick(() => showSection('main'));
            }
            mainButton.show();
        }

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∫–æ–≥–¥–∞ Telegram WebApp –≥–æ—Ç–æ–≤
        tg.ready();

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π Telegram
        tg.onEvent('viewportChanged', (event) => {
            console.log('Viewport changed:', event);
        });

        tg.onEvent('themeChanged', () => {
            console.log('Theme changed');
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        initApp();
    </script>
</body>
</html>
